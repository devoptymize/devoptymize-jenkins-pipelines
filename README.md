# AWS DevOps pipeline architecture - CI/CD of Static-website

### Overview

- This is a Jenkins pipeline script that create AWS codepipeline for  static website with stages like source stage , build stage , deploy stage , invalidation stage and SNS topic for email notification .

![image](./Devoptymize-aws-cicd-sw.png)

### RESOURCES CREATED

- AWS CodePipeline: A fully automated pipeline with source, build, deploy, and invalidation stages.
  
  - Source Stage: Retrieves source code from a repository and triggers the pipeline. It prepares source code for    further processing.
  
  - Build Stage: Transforms source code into deployable artifacts. It compiles, tests, and packages code for deployment.
  
  - Deploy Stage: Releases artifacts to a target environment, making the application available. It ensures consistency between source code and deployed version.

  - Invalidation Stage: Ensures CDN (e.g., CloudFront) reflects the latest changes. It triggers cache removal for updated content, providing users with up-to-date resources.

- S3 Bucket for Artifacts: A designated Amazon S3 bucket to store artifacts generated by CodePipeline.
- Lambda Function for CloudFront Invalidation: A Lambda function responsible for invalidating the CloudFront cache associated with your application.
- AWS SNS for Notifications: Setup for sending notifications through AWS SNS.

- IAM Roles and policies created are:
  - PipelineServiceRole: This IAM role is used for the CodePipeline service. It has the following policies attached:
    - AWSCodePipelineFullAccess
    - AWSCodeCommitFullAccess
    - AWSCodeBuildStartBuild
    - AWSLambdaFullAccess
    - AWSSNSPublishAccess
    - AWSCodeStarNotifications

  - CodeBuildServiceRole: This IAM role is used for the CodeBuild service. It has the following policies attached:
    - AWSCodeBuildFullAccess
    - AWSCodeCommitFullAccess
    - AWSLambdaFullAccess
    - AWSCodedeployFullAccess

  - CloudFrontInvalidationLambdaFunctionRole: This IAM role is used for the Lambda function that handles CloudFront invalidations. It has the following policies attached:
    - CloudFrontFullAccess
    - AWSCodePipeline_FullAccess

  - SNSTopicPolicy: This is an SNS topic policy that allows CodeStar Notifications service to publish to the SNS topic.

  - MyCodeStarNotificationRule: This is a CodeStar Notifications rule that specifies events and targets for notifications. It's associated with the SNS topic.

### PREREQUISITE

- S3 BUCKET : Amazon S3 bucket to host static content.
- CLOUDFRONT DISTRIBUTION ID - CloudFront distribution, which is configured to serve the content from S3 BUCKET. This ID is required for the CloudFront cache invalidation step during the deployment process.

Configuration for CloudFront Distribution:

- Make sure the S3 bucket that you're using for hosting static content is attached as an origin to the CloudFront distribution.
- Configure appropriate Origin Access Control settings to ensure proper interaction between CloudFront and your S3 bucket.

### The Jenkins pipeline includes the following steps

- First, it takes user input in the form of credentials to provision the resources on an AWS account. The pipeline uses the ChoiceParameter to provide a list of credentials to choose from. The GroovyScript block defines the logic to fetch the credentials available in the Jenkins instance and returns a list of credentials associated with the user's login.

- The pipeline then create AWS codepipeline for  static website . It extracts the environment name from the input parameter and uses it to generate the names of the resources. The withCredentials block reads the access key and secret key from the AWS credentials associated with the account and uses them to run the CFT and TF commands that create the vpc configuration.

- The agent any directive specifies that the pipeline can run on any agent machine with a specific label or without a label. In this case, it is not restricted to any agent machine.

- The environment block defines two environment variables that are derived from the user input. PROJECT_NAME is extracted from the credential name, and ACCOUNT_ID is extracted by splitting the credential name at the underscore (_) character.

The pipeline has three stages:

- The first stage cleans the workspace by removing any existing files from it. If the environment name parameter is empty, the pipeline stops and displays an error message. Otherwise, it sets the display name for the current build to include the project name, AWS account ID, and environment name.
- The second stage used for SCM Checkout which instructs jenkins to obtain pipeline from SCM
- The third stage create the aws cicd sw architecture For CFT, The process will wait, it outputs a message indicating that the stack creation is still in progress and waits for 30 seconds before checking the status again, after the stack creation complete. it will commit the output file in ops_devoptimize repo. It uses the if and else block to set the environment variables required for CloudFormationTemplate and Terraform. It then runs the CFT and TF commands to create the aws cicd sw .

- Overall, this script provides a way to automate the creation of resources required for Terraform state management,CloudFormation and resource locking in an AWS account.

### Parameters

Once you have the jenkins set up is done create a Job with the resource specified jenkins file. Then select the **Build with Parameters** in which the following parameters have to be specified.

| Parameters     |                                     Description                                                | Default Values  |
| :------------ |                                      :-----                                                     | :-------- |
| `ACTION`       |This parameter allows the user to select either Create or modify or delete a resources in the AWS account. This parameter will have list of actions such as Create, Modify and Delete.                    | `Create`   |
| `IAC_TOOL`     | This parameter allows the user to select one of the two IAC_TOOLS for creating the resource. The IAC-TOOLS which can be used are Cloudformation or Terraform  | `Terraform`  |
| `CREDENTIAL`       |This parameter allows the user to select the credential which has necessary permission to create a resource in the AWS account.                     | `project_xxxxxxxxxx_aws_cred`   |
| `ENVIRONMENT`       |  The parameter allows the user to enter the Environment in which the required resource can be created. for example: dev and prod environment.                    | `  |
| `REGION`       | This parameter allows the user to select the region in which the RDS Instances can be created. This parameter will have a list of all the regions upon which the user can select the desired region.                 |    |
| `STACK_NAME`       |  This parameter allows the user to enter the desired name of the stack in the dialog box.        |  |
| `S3BUCKETNAME`  |  Name of the Amazon S3 bucket where the artifacts generated by the build process will be stored |   |
| `REPOSITORY_NAME`   |   Name of the AWS CodeCommit repository where your application source code is stored.     |    |
| `BRANCH_NAME`  | Name of the branch in the CodeCommit repository that will be monitored for changes.Whenever changes are pushed to this branch, the pipeline will automatically start. | `main`    |
| `COMPUTE_TYPE` |  The type of compute environment to use. This determines the number of CPU cores and memory for the build environment.Choose the appropriate value based on the resource requirements of your build.   |    |
| `IMAGE`  | The Docker image tag that identifies the Docker image to use for this build project.This image defines the runtime environment for your build and may contain build tools and dependencies. |    |
| `OPERATING_SYSTEM`  | The operating system for the build environment in CodeBuild. Choose the appropriate operating system based on your application's requirements.|    |
| `TYPE` |  The type of build environment to use for related builds.Choose the appropriate value based on the nature of the project and its dependencies.   |    |
| `EMAILS`  |  Email addresses to receive notifications via SNS (Simple Notification Service).Provide a list of email addresses to keep relevant team members informed about build status and issues.. |    |
| `CLOUDFRONT_DISTRIBUTION_ID`  |  ID of the AWS CloudFront distribution associated with your application.This ID will be used to invalidate the CloudFront cache during the deployment process. |    |

### To test the entire flow, follow the steps

- Add following files into Code commit repository

  - index.html: Sample HTML file with a basic "hello world" message.

    ` <h1> hello world </h1> `

  - buildspec.yml: Build specification file used by AWS CodeBuild to define the build and deployment process.

      buildspec.yml

      ```version: 0.2
      phases:
        pre_build:
          commands:
            - echo In the pre_build phase...
        build:
          commands:
            - echo Build started on `date`
            # - mvn install (Uncomment this line if building a Maven project)
        post_build:
          commands:
            - echo Build completed on `date`
      artifacts:
        files:
          - scripts/*
          - index.html  #replace with your code 

      ```

This sample project demonstrates the basic steps to use AWS CodeBuild to build and deploy a simple static website. You can customize the buildspec.yml file and adjust the build process to fit your specific project requirements.

- Note: If the chosen Infrastructure as Code (IAC) tool is set to 'CloudFormation,' the stack will be deleted, but the Code pipeline artifact S3 bucket will be retained. To delete the S3 bucket as well, you can use the following command: `aws s3 rb s3://bucketname --force`.

### Contributing

We welcome contributions from the community to enhance the Jenkins pipeline. If you would like to contribute, please follow our guidelines outlined in the CONTRIBUTING.md file. You can submit feature requests, or pull requests to help us improve the template.

### License
